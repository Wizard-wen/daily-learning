# 缓存策略


服务端设置响应头（cache-control、Expires、last-modified、Etag）给浏览器

## 强制缓存

当客户端请求后，会先访问缓存数据库看缓存是否存在。
如果存在则直接返回，不存在则请求真的服务器。

强制缓存直接减少请求数，是提升最大的缓存策略。
如果考虑使用缓存来优化网页性能的话，强制缓存应该是首先被考虑的。

可以造成强制缓存的字段是 Cache-control 和 Expires

## 协商缓存

当强制缓存失效(超过规定时间)时，就需要使用对比缓存，由服务器决定缓存内容是否失效。对比缓存是可以和强制缓存一起使用。


```shell
max-age= no-store | no-cache | must-revalidate 
```


Cache-Control
ETag
Expired

协商缓存
Last-Modified/if-Modified-Since
ETag/If-None-Match





### 缓存存储策略

缓存存储策略决定了客户端是否应该存储http的response。
- cache-control
    - max-age 缓存的内容将在 xxx 秒后失效，失效前可以直接使用本地缓存，失效后必须向服务器确认资源是否已经改变。
    - no-store 完全不在客户端缓存
    - no-cache 可以认为等同于 max-age=0 的情况，即将 response 缓存在客户端，但是之后每次都向服务器确认资源是否已经改变
    - must-revalidate 告诉浏览器、缓存服务器，本地副本过期前，可以使用本地副本；本地副本一旦过期，必须去源服务器进行有效性校验。
```
server {
    expires    24h;           # 设置Expires为当前时间过后的24小时，Cache-Control的值为24
                              # 小时
    expires    modified +24h; # 编辑Expires增加24小时，Cache-Control的值增加24小时
    expires    $expires;      # 根据变量$expires的内容设置缓存时间
}
```




### 缓存过期策略

缓存过期策略决定了客户端存储在本地的缓存数据是否已过期，

如未过期则可以直接使用本地存储的数据，否则就需要发请求到服务端尝试重新获取数据。

Expires


### 缓存对比策略

将缓存在客户端的数据标识发往服务端，服务端通过标识来判断客户端 缓存数据是否仍有效，进而决定是否要重发数据。


客户端发出 If-Modified-Since、If-None-Match
服务端返回304


### etag实体标签

Nginx 作为 Web 服务器时，对静态资源会 ***自动*** 在响应头中添加响应头字段 Etag，
字段值为 **静态资源文件的最后编辑时间（last_modified_time）** 和 **文件大小** 的十六进制组合。
对于代理的响应内容则由被代理服务器进行控制，不会自动添加 Etag 字段，
只有存在 Nginx 服务器由 Nginx 直接读取的文件时才会自动添加 Etag 字段，它可以通过添加 etag off 指令禁止自动生成 Etag。

### 文件修改时间

Nginx 作为 Web 服务器时，会对静态资源 ***自动*** 添加响应头字段 Last-Modified，
字段值为静态资源文件的最后编辑时间（last_modified_time）。

Nginx 提供了配置指令 if_modified_since，对文件修改时间的服务端校验提供了两种不同的比对方式。
一种是指令值为 exact 时，Nginx 会将请求头中 if_modified_since 的时间与响应数据中的时间做精确匹配，即完全相等才认为客户端缓存有效，返回响应状态码 304；
另一种是指令值为 before 时，则在请求头中 if_modified_since 的时间大于响应数据中的时间也认为客户端缓存有效，返回响应状态码 304。
该指令功能控制处于数据流的出入口，对于任何形式产生的响应数据都有效，当指令值为 off 时，则关闭 Nginx 对客户端缓存文件修改时间的服务端校验功能。

任何与用户私人相关的数据都不应该被缓存，

所以对于私人内容数据建议设置 HTTP 信息头 Cache-Control 字段值为 no-cache、no-store 或 private 控制客户端不进行缓存，

根据数据内容的敏感性，正确设置这些头字段，可以在保持维护私人信息安全的前提下利用缓存的优势提升网站的响应速度。





